openapi: 3.0.0
info:
  title: NethCTI Middleware API
  description: |
    NethCTI Middleware provides authentication, 2FA, phonebook management, 
    and integration with NethVoice/NethCTI systems.
  version: 1.0.0
  contact:
    name: Nethesis
    url: https://www.nethesis.it

servers:
  - url: http://localhost:8080
    description: Local development server
  - url: https://middleware.example.com/api
    description: Production server

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token obtained from /login endpoint
    superAdminAuth:
      type: http
      scheme: bearer
      description: Super admin bearer token for administrative endpoints

  schemas:
    LoginRequest:
      type: object
      required:
        - username
        - password
      properties:
        username:
          type: string
          description: User login name
        password:
          type: string
          format: password
          description: User password

    LoginResponse:
      type: object
      properties:
        expire:
          type: string
          format: date-time
        token:
          type: string
          description: JWT bearer token for subsequent requests

    ErrorResponse:
      type: object
      properties:
        message:
          type: string
        error:
          type: string

    TwoFAStatus:
      type: object
      properties:
        enabled:
          type: boolean
        method:
          type: string
          enum: [totp]

    QRCodeResponse:
      type: object
      properties:
        qr_code:
          type: string
          format: byte
          description: Base64-encoded QR code image

    TokenResponse:
      type: object
      properties:
        token:
          type: string

    TokenExistsResponse:
      type: object
      properties:
        exists:
          type: boolean

    PhonebookImportResponse:
      type: object
      properties:
        message:
          type: string
        total_rows:
          type: integer
          description: Total rows in the CSV
        imported_rows:
          type: integer
          description: Successfully imported rows
        failed_rows:
          type: integer
          description: Failed rows
        skipped_rows:
          type: integer
          description: Skipped rows (validation errors)
        error_messages:
          type: array
          items:
            type: string
          description: List of error messages encountered during import

    SummaryWatchRequest:
      type: object
      required:
        - uniqueid
      properties:
        uniqueid:
          type: string
          description: Unique ID of the call to watch

    SummaryWatchResponse:
      type: object
      properties:
        code:
          type: integer
        message:
          type: string
        data:
          type: object
          properties:
            uniqueid:
              type: string

    SummaryUpdateRequest:
      type: object
      required:
        - summary
      properties:
        summary:
          type: string
          description: Summary text to store for the call

    SummaryListRequest:
      type: object
      required:
        - uniqueids
      properties:
        uniqueids:
          type: array
          items:
            type: string

    SummaryCheckResponse:
      type: object
      properties:
        code:
          type: integer
        message:
          type: string
        data:
          type: object
          properties:
            uniqueid:
              type: string
            has_summary:
              type: boolean

    SummaryListItem:
      type: object
      properties:
        uniqueid:
          type: string
        state:
          type: string
        has_transcription:
          type: boolean
        has_summary:
          type: boolean
        updated_at:
          type: string
          format: date-time
          nullable: true
      required:
        - uniqueid
        - state
        - has_transcription
        - has_summary
        - updated_at

    SummaryListNotFoundItem:
      type: object
      properties:
        uniqueid:
          type: string
        error:
          type: string
          enum: [not_found]
      required:
        - uniqueid
        - error

    SummaryListResponse:
      type: object
      properties:
        code:
          type: integer
        message:
          type: string
        data:
          type: array
          items:
            oneOf:
              - $ref: '#/components/schemas/SummaryListItem'
              - $ref: '#/components/schemas/SummaryListNotFoundItem'

    TranscriptionResponse:
      type: object
      properties:
        code:
          type: integer
        message:
          type: string
        data:
          type: object
          properties:
            uniqueid:
              type: string
            transcription:
              type: string

    SummaryResponse:
      type: object
      properties:
        code:
          type: integer
        message:
          type: string
        data:
          type: object
          properties:
            uniqueid:
              type: string
            summary:
              type: string
            sentiment:
              type: integer
              nullable: true
            state:
              type: string
            transcription:
              type: string
            created_at:
              type: string
              format: date-time
            updated_at:
              type: string
              format: date-time
            deleted_at:
              type: string
              format: date-time
              nullable: true

    SummaryDeleteResponse:
      type: object
      properties:
        code:
          type: integer
        message:
          type: string
        data:
          type: object
          properties:
            uniqueid:
              type: string

paths:
  /login:
    post:
      summary: User login
      operationId: login
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Successful login
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /logout:
    post:
      summary: User logout
      operationId: logout
      tags:
        - Authentication
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Successful logout
        '401':
          description: Unauthorized
        '503':
          description: Satellite database not configured
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /transcripts/summary/watch:
    post:
      summary: Watch for call summary
      operationId: watchCallSummary
      tags:
        - Transcripts
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SummaryWatchRequest'
      responses:
        '202':
          description: Watch started
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SummaryWatchResponse'
        '200':
          description: Watch already active or unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SummaryWatchResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized

  /summary/check/{uniqueid}:
    get:
      summary: Check summary availability by unique ID
      operationId: checkSummaryByUniqueId
      tags:
        - Transcripts
      security:
        - bearerAuth: []
      parameters:
        - name: uniqueid
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Summary available
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SummaryCheckResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Summary not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: Service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /summary/check/list:
    post:
      summary: List summary/transcription status for provided unique IDs
      operationId: listSummaryStatus
      tags:
        - Transcripts
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SummaryListRequest'
      responses:
        '200':
          description: Summary status list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SummaryListResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: Service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /transcripts/{uniqueid}:
    get:
      summary: Get transcription by unique ID
      operationId: getTranscriptionByUniqueId
      tags:
        - Transcripts
      security:
        - bearerAuth: []
      parameters:
        - name: uniqueid
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Transcription retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TranscriptionResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: Service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /transcripts/summary/{uniqueid}:
    get:
      summary: Get summary by unique ID
      operationId: getSummaryByUniqueId
      tags:
        - Transcripts
      security:
        - bearerAuth: []
      parameters:
        - name: uniqueid
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Summary retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SummaryResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: Service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    put:
      summary: Update summary by unique ID
      operationId: updateSummaryByUniqueId
      tags:
        - Transcripts
      security:
        - bearerAuth: []
      parameters:
        - name: uniqueid
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SummaryUpdateRequest'
      responses:
        '200':
          description: Summary updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SummaryResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: Service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    delete:
      summary: Delete summary by unique ID
      operationId: deleteSummaryByUniqueId
      tags:
        - Transcripts
      security:
        - bearerAuth: []
      parameters:
        - name: uniqueid
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Summary deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SummaryDeleteResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: Service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /2fa/status:
    get:
      summary: Get 2FA status
      operationId: get2FAStatus
      tags:
        - Two-Factor Authentication
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Current 2FA status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TwoFAStatus'
        '401':
          description: Unauthorized

  /2fa/qr-code:
    get:
      summary: Get 2FA QR code for TOTP setup
      operationId: get2FAQRCode
      tags:
        - Two-Factor Authentication
      security:
        - bearerAuth: []
      responses:
        '200':
          description: QR code image
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QRCodeResponse'
        '401':
          description: Unauthorized

  /2fa/verify-otp:
    post:
      summary: Verify OTP token and enable 2FA
      operationId: verify2FAOTP
      tags:
        - Two-Factor Authentication
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - otp_code
              properties:
                otp_code:
                  type: string
                  description: 6-digit TOTP code
      responses:
        '200':
          description: OTP verified successfully
        '400':
          description: Invalid OTP
        '401':
          description: Unauthorized

  /2fa/disable:
    post:
      summary: Disable 2FA
      operationId: disable2FA
      tags:
        - Two-Factor Authentication
      security:
        - bearerAuth: []
      responses:
        '200':
          description: 2FA disabled
        '401':
          description: Unauthorized

  /2fa/recovery-codes:
    post:
      summary: Get 2FA recovery codes
      operationId: get2FARecoveryCodes
      tags:
        - Two-Factor Authentication
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Recovery codes
          content:
            application/json:
              schema:
                type: object
                properties:
                  recovery_codes:
                    type: array
                    items:
                      type: string
        '401':
          description: Unauthorized

  /tokens/persistent/{audience}:
    post:
      summary: Create persistent integration token
      operationId: createPersistentToken
      tags:
        - Integration Tokens
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: audience
          required: true
          schema:
            type: string
            enum: [phone-island, mobile-app, nethlink]
          description: Integration token audience
      responses:
        '200':
          description: JWT persistent integration token (exp set to 100 years, aud set to audience)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '400':
          description: Invalid audience
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
    get:
      summary: Check persistent integration token existence
      operationId: checkPersistentToken
      tags:
        - Integration Tokens
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: audience
          required: true
          schema:
            type: string
            enum: [phone-island, mobile-app, nethlink]
          description: Integration token audience
      responses:
        '200':
          description: Token state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenExistsResponse'
        '400':
          description: Invalid audience
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
    delete:
      summary: Remove persistent integration token(s)
      operationId: removePersistentToken
      tags:
        - Integration Tokens
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: audience
          required: true
          schema:
            type: string
            enum: [phone-island, mobile-app, nethlink]
          description: Integration token audience
      responses:
        '204':
          description: Token(s) removed
        '400':
          description: Invalid audience
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized

  /authentication/phone_island_token_login:
    post:
      summary: Create Phone Island token (legacy endpoint)
      operationId: phoneIslandTokenLoginLegacy
      tags:
        - Integration Tokens
      deprecated: true
      security:
        - bearerAuth: []
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                subtype:
                  type: string
                  description: Legacy subtype; "nethlink" maps to nethlink audience, defaults to phone-island
      responses:
        '200':
          description: JWT persistent integration token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '401':
          description: Unauthorized

  /authentication/persistent_token_remove:
    post:
      summary: Remove persistent token (legacy endpoint)
      operationId: phoneIslandTokenRemoveLegacy
      tags:
        - Integration Tokens
      deprecated: true
      security:
        - bearerAuth: []
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                type:
                  type: string
                subtype:
                  type: string
                  description: Legacy subtype; "nethlink" maps to nethlink audience, defaults to phone-island
      responses:
        '204':
          description: Token(s) removed
        '401':
          description: Unauthorized

  /authentication/phone_island_token_check:
    get:
      summary: Check Phone Island token (legacy endpoint)
      operationId: phoneIslandTokenCheckLegacy
      tags:
        - Integration Tokens
      deprecated: true
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Token state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenExistsResponse'
        '401':
          description: Unauthorized

  /phonebook/import/:
    post:
      summary: Import phonebook contacts for authenticated user
      operationId: importPhonebook
      tags:
        - Phonebook
      description: |
        Import phonebook contacts for the authenticated user. The request must be
        a multipart/form-data POST with a single file field named `file` containing
        the CSV of contacts. The authenticated user's JWT must contain the
        capability `phonebook.ad_phonebook` to allow import.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
              properties:
                file:
                  type: string
                  format: binary
                  description: CSV file containing phonebook contacts
            examples:
              sample_csv_upload:
                summary: Example CSV multipart upload
                value:
                  file: "contacts.csv"
                  csv_content: |
                    name,workemail,cellphone
                    John Doe,john@example.com,555-1234
                    Jane Smith,jane@example.com,555-5678
      responses:
        '200':
          description: Phonebook import completed for the authenticated user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PhonebookImportResponse'
        '400':
          description: Bad request - missing file or invalid CSV
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized - invalid or missing JWT
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                    example: 401
                  message:
                    type: string
                    example: "authorization required"
        '403':
          description: Forbidden - missing capability (phonebook.ad_phonebook)
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                    example: 403
                  message:
                    type: string
                    example: "forbidden: missing capability"

  /admin/phonebook/import:
    post:
      summary: Import phonebook contacts (Super Admin only)
      operationId: adminImportPhonebook
      tags:
        - Administration
      description: |
        Admin phonebook import endpoint for super administrators.

        This endpoint allows super administrators to import phonebook contacts
        from a CSV file into any target user's phonebook. The target username
        must be provided as a form field.

        CSV Format: Requires multipart/form-data with:
        - Field "username" (string, required): Target username to import contacts for
        - Field "file" (binary, required): CSV file with contact data

        CSV Columns (case-insensitive): name (required),
        and optional: workemail, homeemail, workphone, homephone, cellphone, fax, title,
        company, notes, homestreet, homepob, homecity, homeprovince, homepostalcode,
        homecountry, workstreet, workpob, workcity, workprovince, workpostalcode,
        workcountry, url, extension, speeddial_num, type (optional, default: private).

        Security: Requires two factors of authentication:
        1. IP Whitelist - Request must come from an allowed IP/CIDR range (default: 127.0.0.0/8)
        2. Bearer Token - Must provide valid super admin token in Authorization header
      security:
        - superAdminAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - username
                - file
              properties:
                username:
                  type: string
                  description: Target username to import contacts for
                  example: john.smith
                file:
                  type: string
                  format: binary
                  description: CSV file containing phonebook contacts
      responses:
        '200':
          description: Phonebook import completed
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "phonebook import completed"
                  total_rows:
                    type: integer
                    example: 10
                  imported_rows:
                    type: integer
                    example: 9
                  failed_rows:
                    type: integer
                    example: 0
                  skipped_rows:
                    type: integer
                    example: 1
                  error_messages:
                    type: array
                    items:
                      type: string
                    example: ["Row 5: invalid type 'business' (must be 'private' or 'public')"]
        '400':
          description: Bad request - missing username field or invalid CSV
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "username field is required"
        '401':
          description: Unauthorized - invalid or missing super admin token
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                    example: 401
                  message:
                    type: string
                    example: "super admin authentication required"
        '403':
          description: Forbidden - client IP is not in the super admin allowed IP whitelist
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                    example: 403
                  message:
                    type: string
                    example: "access denied: IP not in allowed list"
        '404':
          description: Not found - target user does not exist
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "target user not found"

  /admin/reload/profiles:
    post:
      summary: Reload profiles and users configuration (Super Admin only)
      operationId: adminReloadProfiles
      tags:
        - Administration
      description: |
        Trigger a global reload of profiles and users configuration from the configured JSON files.
        This endpoint is intended for super-administrators and will call the internal reload routine
        to refresh in-memory profiles and users without restarting the service.
      security:
        - superAdminAuth: []
      responses:
        '200':
          description: Profiles reloaded successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                    example: 200
                  message:
                    type: string
                    example: "profiles reloaded successfully"
                  data:
                    type: empty object

              examples:
                success:
                  summary: Successful reload example
                  value:
                    code: 200
                    message: "profiles reloaded successfully"
                    data:
                      trigger: "api"
        '500':
          description: Internal server error when reload fails
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                    example: 500
                  message:
                    type: string
                    example: "failed to reload profiles"
                  data:
                    type: string
                    description: Error details
              examples:
                failure:
                  summary: Failure example
                  value:
                    code: 500
                    message: "failed to reload profiles"
                    data: "parse profiles: invalid character 'i'"

tags:
  - name: Authentication
    description: Login and session management
  - name: Two-Factor Authentication
    description: TOTP-based 2FA management
  - name: Phonebook
    description: Phonebook management and CSV import
  - name: Phone Island Integration
    description: Phone Island token and authentication
  - name: Administration
    description: Administrative operations requiring super admin authentication

openapi: 3.0.0
info:
  title: NethCTI Middleware API
  description: |
    NethCTI Middleware provides authentication, 2FA, phonebook management, 
    and integration with NethVoice/NethCTI systems.
  version: 1.0.0
  contact:
    name: Nethesis
    url: https://www.nethesis.it

servers:
  - url: http://localhost:8080
    description: Local development server
  - url: https://middleware.example.com/api
    description: Production server

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token obtained from /login endpoint
    superAdminAuth:
      type: http
      scheme: bearer
      description: Super admin bearer token for administrative endpoints

  schemas:
    LoginRequest:
      type: object
      required:
        - username
        - password
      properties:
        username:
          type: string
          description: User login name
        password:
          type: string
          format: password
          description: User password

    LoginResponse:
      type: object
      properties:
        expire:
          type: string
          format: date-time
        token:
          type: string
          description: JWT bearer token for subsequent requests

    ErrorResponse:
      type: object
      properties:
        message:
          type: string
        error:
          type: string

    TwoFAStatus:
      type: object
      properties:
        enabled:
          type: boolean
        method:
          type: string
          enum: [totp]

    QRCodeResponse:
      type: object
      properties:
        qr_code:
          type: string
          format: byte
          description: Base64-encoded QR code image

    PhoneIslandTokenResponse:
      type: object
      properties:
        token:
          type: string

    PhonebookImportResponse:
      type: object
      properties:
        message:
          type: string
        total_rows:
          type: integer
          description: Total rows in the CSV
        imported_rows:
          type: integer
          description: Successfully imported rows
        failed_rows:
          type: integer
          description: Failed rows
        skipped_rows:
          type: integer
          description: Skipped rows (validation errors)
        error_messages:
          type: array
          items:
            type: string
          description: List of error messages encountered during import

paths:
  /login:
    post:
      summary: User login
      operationId: login
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Successful login
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /logout:
    post:
      summary: User logout
      operationId: logout
      tags:
        - Authentication
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Successful logout
        '401':
          description: Unauthorized

  /2fa/status:
    get:
      summary: Get 2FA status
      operationId: get2FAStatus
      tags:
        - Two-Factor Authentication
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Current 2FA status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TwoFAStatus'
        '401':
          description: Unauthorized

  /2fa/qr-code:
    get:
      summary: Get 2FA QR code for TOTP setup
      operationId: get2FAQRCode
      tags:
        - Two-Factor Authentication
      security:
        - bearerAuth: []
      responses:
        '200':
          description: QR code image
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QRCodeResponse'
        '401':
          description: Unauthorized

  /2fa/verify-otp:
    post:
      summary: Verify OTP token and enable 2FA
      operationId: verify2FAOTP
      tags:
        - Two-Factor Authentication
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - otp_code
              properties:
                otp_code:
                  type: string
                  description: 6-digit TOTP code
      responses:
        '200':
          description: OTP verified successfully
        '400':
          description: Invalid OTP
        '401':
          description: Unauthorized

  /2fa/disable:
    post:
      summary: Disable 2FA
      operationId: disable2FA
      tags:
        - Two-Factor Authentication
      security:
        - bearerAuth: []
      responses:
        '200':
          description: 2FA disabled
        '401':
          description: Unauthorized

  /2fa/recovery-codes:
    post:
      summary: Get 2FA recovery codes
      operationId: get2FARecoveryCodes
      tags:
        - Two-Factor Authentication
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Recovery codes
          content:
            application/json:
              schema:
                type: object
                properties:
                  recovery_codes:
                    type: array
                    items:
                      type: string
        '401':
          description: Unauthorized

  /authentication/phone_island_token_login:
    post:
      summary: Phone Island token login
      operationId: phoneIslandTokenLogin
      tags:
        - Phone Island Integration
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              description: Send an empty JSON object (`{}`) as the request body.
      responses:
        '200':
          description: Token generated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PhoneIslandTokenResponse'
        '401':
          description: Unauthorized

  /authentication/phone_island_token_check:
    get:
      summary: Check Phone Island token validity
      operationId: phoneIslandTokenCheck
      tags:
        - Phone Island Integration
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Token is valid
        '401':
          description: Token invalid or expired

  /authentication/persistent_token_remove:
    post:
      summary: Remove persistent token
      operationId: phoneIslandTokenRemove
      tags:
        - Phone Island Integration
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Token removed
        '401':
          description: Unauthorized

  /admin/phonebook/import:
    post:
      summary: Import phonebook contacts (Super Admin only)
      operationId: adminImportPhonebook
      tags:
        - Administration
      description: |
        Admin phonebook import endpoint for super administrators.

        This endpoint allows super administrators to import phonebook contacts
        from a CSV file into any target user's phonebook. The target username
        must be provided as a form field.

        CSV Format: Requires multipart/form-data with:
        - Field "username" (string, required): Target username to import contacts for
        - Field "file" (binary, required): CSV file with contact data

        CSV Columns (case-insensitive): name (required),
        and optional: workemail, homeemail, workphone, homephone, cellphone, fax, title,
        company, notes, homestreet, homepob, homecity, homeprovince, homepostalcode,
        homecountry, workstreet, workpob, workcity, workprovince, workpostalcode,
        workcountry, url, extension, speeddial_num, type (optional, default: private).

        Security: Requires two factors of authentication:
        1. IP Whitelist - Request must come from an allowed IP/CIDR range (default: 127.0.0.0/8)
        2. Bearer Token - Must provide valid super admin token in Authorization header
      security:
        - superAdminAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - username
                - file
              properties:
                username:
                  type: string
                  description: Target username to import contacts for
                  example: john.smith
                file:
                  type: string
                  format: binary
                  description: CSV file containing phonebook contacts
      responses:
        '200':
          description: Phonebook import completed
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "phonebook import completed"
                  total_rows:
                    type: integer
                    example: 10
                  imported_rows:
                    type: integer
                    example: 9
                  failed_rows:
                    type: integer
                    example: 0
                  skipped_rows:
                    type: integer
                    example: 1
                  error_messages:
                    type: array
                    items:
                      type: string
                    example: ["Row 5: invalid type 'business' (must be 'private' or 'public')"]
        '400':
          description: Bad request - missing username field or invalid CSV
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "username field is required"
        '401':
          description: Unauthorized - invalid or missing super admin token
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                    example: 401
                  message:
                    type: string
                    example: "super admin authentication required"
        '403':
          description: Forbidden - client IP is not in the super admin allowed IP whitelist
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                    example: 403
                  message:
                    type: string
                    example: "access denied: IP not in allowed list"
        '404':
          description: Not found - target user does not exist
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "target user not found"

tags:
  - name: Authentication
    description: Login and session management
  - name: Two-Factor Authentication
    description: TOTP-based 2FA management
  - name: Phonebook
    description: Phonebook management and CSV import
  - name: Phone Island Integration
    description: Phone Island token and authentication
  - name: Administration
    description: Administrative operations requiring super admin authentication
